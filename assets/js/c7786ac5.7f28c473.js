"use strict";(self.webpackChunkproject_website=self.webpackChunkproject_website||[]).push([[4931],{40963:(e,t,s)=>{s.r(t),s.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>i,metadata:()=>n,toc:()=>d});const n=JSON.parse('{"id":"developer-guide/testing","title":"Testing","description":"Testing WebGL2/WebGPU code is much harder than testing regular JavaScript. GPU and browser dependent commands may not run under Node. Rendering behavior differs cross platforms and hardware. Since it draws into a canvas, there is also no precisely verifiable output.","source":"@site/../docs/developer-guide/testing.md","sourceDirName":"developer-guide","slug":"/developer-guide/testing","permalink":"/docs/developer-guide/testing","draft":false,"unlisted":false,"editUrl":"https://github.com/visgl/deck.gl/tree/master/website/../docs/developer-guide/testing.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Debugging","permalink":"/docs/developer-guide/debugging"},"next":{"title":"WebGPU","permalink":"/docs/developer-guide/webgpu"}}');var r=s(74848),a=s(28453);const i={},o="Testing",l={},d=[{value:"Unit Tests for deck.gl Layers",id:"unit-tests-for-deckgl-layers",level:2},{value:"Example",id:"example",level:3},{value:"Integration Tests",id:"integration-tests",level:2},{value:"Example",id:"example-1",level:3}];function c(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.header,{children:(0,r.jsx)(t.h1,{id:"testing",children:"Testing"})}),"\n",(0,r.jsx)(t.p,{children:"Testing WebGL2/WebGPU code is much harder than testing regular JavaScript. GPU and browser dependent commands may not run under Node. Rendering behavior differs cross platforms and hardware. Since it draws into a canvas, there is also no precisely verifiable output."}),"\n",(0,r.jsxs)(t.p,{children:["The ",(0,r.jsx)(t.a,{href:"/docs/api-reference/test-utils/overview",children:"@deck.gl/test-utils"})," module is used to ensure the quality and stability of the deck.gl framework. It is also available for those who need to test their own custom layers and/or deck.gl applications."]}),"\n",(0,r.jsx)(t.h2,{id:"unit-tests-for-deckgl-layers",children:"Unit Tests for deck.gl Layers"}),"\n",(0,r.jsxs)(t.p,{children:["Lifecycle test functions are designed to allow for integration with different unit test frameworks. Some of the details depend on the test framework you are using. deck.gl itself uses ",(0,r.jsx)(t.code,{children:"tape"})," so the tests in the deck.gl repository contain extensive examples of ",(0,r.jsx)(t.code,{children:"tape"})," integration, but it should also be straightforward to integrate with other unit testing frameworks."]}),"\n",(0,r.jsx)(t.h3,{id:"example",children:"Example"}),"\n",(0,r.jsxs)(t.p,{children:["Using ",(0,r.jsx)(t.a,{href:"/docs/api-reference/test-utils/test-layer",children:"testLayer"})," util to instantiate a layer and test a series of prop updates:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-js",children:"import test from 'tape-promise/tape';\nimport {testLayer} from '@deck.gl/test-utils';\nimport {GeoJsonLayer} from '@deck.gl/layers';\n\ntest('GeoJsonLayer#tests', t => {\n  testLayer({Layer: GeoJsonLayer, testCases: [\n    // Test case 1\n    {\n      props: {data: []}\n    },\n    // Test case 2\n    {\n      props: {\n        data: SAMPLE_GEOJSON\n      },\n      assert({layer, oldState}) {\n        t.ok(layer.state.features !== oldState.features, 'should update features');\n        t.is(subLayers.length, 2, 'should render 2 subLayers');\n      }\n    },\n    // Test case 3\n    {\n      updateProps: {\n        // will be merged with the previous props\n        lineWidthScale: 3\n      },\n      assert({subLayers}) {\n        const pathLayer = subLayers.find(layer => layer.id.endsWith('linestrings'));\n        t.is(pathLayer.props.widthScale, 3, 'widthScale is passed to sub layer');\n      }\n    }\n  ]});\n\n  t.end();\n});\n"})}),"\n",(0,r.jsxs)(t.p,{children:["The ",(0,r.jsx)(t.a,{href:"/docs/api-reference/test-utils/generate-layer-tests",children:"generateLayerTests"})," utility automatically generates a series of test cases for ",(0,r.jsx)(t.code,{children:"testLayers"})," based on the layer class' default props. It is useful for checking the conformance of a layer class:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-js",children:"import test from 'tape-promise/tape';\nimport {testLayer, generateLayerTests} from '@deck.gl/test-utils';\nimport {GeoJsonLayer} from '@deck.gl/layers';\n\ntest('GeoJsonLayer#tests', t => {\n  \n  const testCases = generateLayerTests({\n    Layer: GeoJsonLayer,\n    sampleProps: {\n      data: SAMPLE_GEOJSON\n    },\n    assert: ({layer, subLayers}) => {\n      t.ok(layer.state.features, 'should update features');\n      t.is(subLayers.length, layer.props.stroked ? 2 : 1, 'correct number of sublayers');\n    }\n  });\n\n  testLayer({Layer: GeoJsonLayer, testCases});\n\n  t.end();\n});\n"})}),"\n",(0,r.jsx)(t.h2,{id:"integration-tests",children:"Integration Tests"}),"\n",(0,r.jsx)(t.p,{children:"While unit tests are good at capturing issues in layer initialization and prop updates, they do not guarantee that the layer will be correctly rendered to screen. Some issues in e.g. the GPU shaders can only be spotted in an integration test."}),"\n",(0,r.jsxs)(t.p,{children:["The ",(0,r.jsx)(t.code,{children:"@deck.gl/test-utils"})," module offers a ",(0,r.jsx)(t.a,{href:"/docs/api-reference/test-utils/snapshot-test-runner",children:"SnapshotTestRunner"})," that works with the ",(0,r.jsx)(t.a,{href:"https://uber-web.github.io/probe.gl",children:"probe.gl"})," library's ",(0,r.jsx)(t.a,{href:"https://uber-web.github.io/probe.gl/docs/api-reference/test-utils/browser-test-driver",children:(0,r.jsx)(t.code,{children:"BrowserTestDriver"})})," class to perform this task. Together, they enable the following scenario:"]}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"start a controlled Chromium browser instance"}),"\n",(0,r.jsx)(t.li,{children:"start a server (we use a webpack-dev-server) that bundles a test script."}),"\n",(0,r.jsx)(t.li,{children:"the test script renders a set of tests (described below), compares the output against golden images and report the result back to the Node process"}),"\n",(0,r.jsx)(t.li,{children:"closes down all processes and browser tabs."}),"\n",(0,r.jsxs)(t.li,{children:["the node process exists with a ",(0,r.jsx)(t.code,{children:"0"})," (success) or ",(0,r.jsx)(t.code,{children:"1"})," if any test failed."]}),"\n"]}),"\n",(0,r.jsx)(t.h3,{id:"example-1",children:"Example"}),"\n",(0,r.jsx)(t.p,{children:"In your node.js start script:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-js",children:"// This is the script that runs in Node.js and starts the browser\nconst {BrowserTestDriver} = require('@probe.gl/test-utils');\nnew BrowserTestDriver().run({\n  server: {\n    // Bundles and serves the browser script\n    command: 'webpack-dev-server',\n    arguments: ['--env.render-test']\n  },\n  headless: true\n});\n"})}),"\n",(0,r.jsx)(t.p,{children:"In your script that is run on the browser:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-js",children:"const {SnapshotTestRunner} = require('@deck.gl/test-utils');\nconst {ScatterplotLayer} = require('@deck.gl/layers');\n\nconst TEST_CASES = [\n  {\n    name: 'ScatterplotLayer',\n    // `Deck` props\n    viewState: {\n      longitude: -122.4,\n      latitude: 37.8,\n      zoom: 12,\n      pitch: 20\n    },\n    layers: [\n      new ScatterplotLayer({\n        id: 'circles',\n        data: './data/scatterplot.json',\n        getPosition: d => d.position,\n        getRadius: d => d.size,\n        getFillColor: [255, 0, 0]\n      })\n    ],\n    // `done` must be called when ready for screenshot and compare\n    onAfterRender: ({layers, done}) => {\n      if (layers[0].props.data.length) {\n        // data is loaded\n        done();\n      }\n    },\n    // Target rendering result\n    goldenImage: './test/render/golden-images/scatterplot.png'\n  }\n];\n\nnew TestRender({width: 800, height: 600})\n  .add(TEST_CASES)\n  .run({\n    onTestFail: window.browserTestDriver_fail\n  })\n  .then(window.browserTestDriver_finish);\n"})})]})}function h(e={}){const{wrapper:t}={...(0,a.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},28453:(e,t,s)=>{s.d(t,{R:()=>i,x:()=>o});var n=s(96540);const r={},a=n.createContext(r);function i(e){const t=n.useContext(a);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),n.createElement(a.Provider,{value:t},e.children)}}}]);